<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>综合控制面板</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- 添加jQuery for AJAX -->
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; max-width: 1200px; margin: auto; }
        .section { border: 1px solid #ccc; padding: 10px; height: 400px; overflow: hidden; } /* 固定高度，无滚动 */
        h2 { font-size: 16px; margin: 5px 0; }
        .motor { margin-bottom: 10px; }
        .motor label { display: block; font-size: 14px; }
        .motor select, .motor input[type="range"] { width: 100%; }
        .status { font-size: 12px; color: green; }
        ul { list-style: none; padding: 0; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        table th, table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        table input { width: 50px; }
        input[type="submit"] { margin-top: 10px; width: 100%; }
        .switch-pressed { color: red; } /* 按下通知颜色 */
    </style>
    <script>
        var socket = io();
        socket.on('update_pwms', function(pwms) {
            for (var i = 0; i < 8; i++) {
                document.getElementById('pwm' + (i+1)).innerText = pwms[i];
            }
        });
        socket.on('update_switches', function(states) {
            var switch1 = document.getElementById('switch1');
            var switch2 = document.getElementById('switch2');
            switch1.innerText = states[0];
            switch2.innerText = states[1];
            switch1.className = (states[0] === 1) ? 'switch-pressed' : '';
            switch2.className = (states[1] === 1) ? 'switch-pressed' : '';
        });

        // 实时控制函数
        function controlMotor(motor) {
            var direction = document.getElementById('direction_' + motor).value;
            var speed = document.getElementById('speed_' + motor).value;
            $.post('/control', { motor: motor, direction: direction, speed: speed }, function(data) {
                // 更新状态，无消息提示
                document.getElementById('status_' + motor).innerText = '当前: ' + direction + ' at ' + speed;
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- 电机控制部分（左侧） -->
        <div class="section">
            <h2>电机控制</h2>
            {% for m in range(1, 5) %}
            <div class="motor">
                <label>电机 {{ m }}</label>
                <select id="direction_{{ m }}" name="direction" onchange="controlMotor({{ m }})">
                    <option value="CW">CW</option>
                    <option value="CCW">CCW</option>
                    <option value="STOP">STOP</option>
                </select>
                <input type="range" id="speed_{{ m }}" name="speed" min="0" max="255" value="0" oninput="controlMotor({{ m }})">
                <p class="status" id="status_{{ m }}">当前: STOP at 0</p>
            </div>
            {% endfor %}
        </div>

        <!-- 推进器PWM显示（中间） -->
        <div class="section">
            <h2>推进器 PWM 值</h2>
            <ul>
                {% for i in range(1, 9) %}
                    <li>推进器 {{ i }}: <span id="pwm{{ i }}">{{ pwms[i-1] }}</span></li>
                {% endfor %}
            </ul>
        </div>

        <!-- TAM配置（右侧） -->
        <div class="section">
            <h2>TAM 配置</h2>
            <form action="/update_tam" method="POST">
                <table>
                    <tr>
                        <th>推进器</th>
                        <th>surge</th>
                        <th>sway</th>
                        <th>heave</th>
                    </tr>
                    {% for i in range(8) %}
                        <tr>
                            <td>{{ i+1 }}</td>
                            {% for j in range(3) %}
                                <td><input type="number" step="0.1" name="tam_{{ i }}_{{ j }}" value="{{ tam[i][j] }}"></td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </table>
                <input type="submit" value="保存">
            </form>
        </div>

        <!-- 开关状态显示 -->
        <div class="section">
            <h2>开关状态</h2>
            <ul>
                <li>开关1: <span id="switch1">0</span></li>
                <li>开关2: <span id="switch2">0</span></li>
            </ul>
        </div>
    </div>
</body>
</html>
